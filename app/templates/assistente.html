{% extends "base.html" %}

{% block title %}Assistente de Limites - Solve WM{% endblock %}

{% block styles %}
<style>
    .chat-page-wrapper { display: flex; justify-content: center; align-items: center; height: calc(100vh - 76px); padding: 10px 0; }
    #chat-container { width: 90%; max-width: 700px; height: 100%; background-color: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
    #chat-box { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    .message { display: flex; max-width: 100%; }
    .user-message { align-self: flex-end; justify-content: flex-end; }
    .bot-message { align-self: flex-start; align-items: flex-end; gap: 10px; }
    .bubble { border-radius: 18px; padding: 10px 15px; max-width: 500px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
    .user-message .bubble { background-color: #3182CE; color: white; border-bottom-right-radius: 4px; }
    .user-message .bubble img { max-width: 100%; max-height: 250px; width: auto; border-radius: 15px; display: block; }
    .bot-message .bubble { background-color: #EBF8FF; color: #2D3748; border-bottom-left-radius: 4px; }
    .bot-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #E2E8F0; flex-shrink: 0; }
    .bubble ul { padding-left: 20px; margin: 8px 0 0 0; }
    .bubble strong { color: #2B6CB0; }
    #input-area { display: flex; padding: 10px 15px; border-top: 1px solid #E2E8F0; align-items: center; background-color: #F7FAFC; flex-shrink: 0; }
    #user-input { flex-grow: 1; border: 1px solid #CBD5E0; border-radius: 20px; padding: 10px 18px; font-size: 1em; }
    #user-input:focus { outline: none; border-color: #3182CE; box-shadow: 0 0 0 2px #BEE3F8; }
    .action-button { background-color: #3182CE; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; flex-shrink: 0; }
    .action-button:hover { background-color: #2B6CB0; }
    #send-btn { margin-left: 10px; font-size: 1.5em; }
    #file-upload-label { margin-right: 5px; }
    #image-input { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="chat-page-wrapper">
    <div id="chat-container">
        <div id="chat-box" aria-live="polite">
            <div class="message bot-message">
                <img src="/static/img_logo.png" alt="Bot Avatar" class="bot-avatar">
                <div class="bubble">
                    OlÃ¡! ðŸ‘‹ Sou o Assistente. <br>
                    - Clique no ðŸ“Ž para enviar uma <strong>imagem</strong> de um limite. <br>
                    - Ou digite um limite usando a sintaxe <strong>funÃ§Ã£o x->ponto</strong> e envie.
                </div>
            </div>
        </div>
        <div id="input-area">
            <label for="image-input" id="file-upload-label" class="action-button" title="Enviar imagem">
                <svg viewBox="0 0 24 24" fill="white" width="24px" height="24px"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"></path></svg>
            </label>
            <input type="file" id="image-input" accept="image/*">
            <input type="text" id="user-input" placeholder="Ex: (x**2 - 4)/(x - 2) x->2" autocomplete="off">
            <button id="send-btn" class="action-button" aria-label="Enviar mensagem">âž¤</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const imageInput = document.getElementById('image-input');

    function scrollToBottom() {
        setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 100);
    }

    sendBtn.addEventListener('click', handleTextMessage);
    userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleTextMessage(); } });
    imageInput.addEventListener('change', handleImageUpload);

    function appendMessage(htmlContent, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', `${sender}-message`);
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = htmlContent;
        if (sender === 'bot') {
            const avatar = document.createElement('img');
            avatar.src = '/static/img_logo.png';
            avatar.alt = 'Bot Avatar';
            avatar.className = 'bot-avatar';
            messageDiv.appendChild(avatar);
        }
        messageDiv.appendChild(bubble);
        chatBox.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
    }

    async function handleApiResponse(response, thinkingMessage) {
        if (response.redirected) {
            window.location.href = response.url;
            return null;
        }
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            if (thinkingMessage) thinkingMessage.querySelector('.bubble').innerHTML = `<strong>Erro Inesperado:</strong> O servidor nÃ£o respondeu corretamente. Verifique o terminal para mais detalhes.`;
            throw new TypeError("A resposta nÃ£o Ã© um JSON vÃ¡lido.");
        }

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.tipo || data.raw_latex || 'Ocorreu um erro desconhecido.');
        }
        return data;
    }

    async function handleTextMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        appendMessage(text, 'user');
        userInput.value = '';
        await getTextoResponse(text);
    }

    async function handleImageUpload() {
        const file = imageInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => appendMessage(`<img src="${e.target.result}" alt="Imagem enviada" onload="scrollToBottom()">`, 'user');
        reader.readAsDataURL(file);
        
        const thinkingMessage = appendMessage('Analisando imagem...', 'bot');
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/process_image', { method: 'POST', body: formData });
            const data = await handleApiResponse(response, thinkingMessage);
            if (data) {
                thinkingMessage.remove(); 
                await getLatexResponse(data.raw_latex);
            }
        } catch (e) {
            if(thinkingMessage) thinkingMessage.querySelector('.bubble').innerHTML = `<strong>Erro:</strong> ${e.message}`;
        }
    }

    async function getTextoResponse(textString) {
        const thinkingMessage = appendMessage('Calculando...', 'bot');
        try {
            const resp = await fetch('/calcular_texto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ expressao: textString })
            });
            const json = await handleApiResponse(resp, thinkingMessage);
            if (json) {
                thinkingMessage.remove();
                renderFinalResponse(json);
            }
        } catch (e) {
            if(thinkingMessage) thinkingMessage.querySelector('.bubble').innerHTML = `<strong>Erro:</strong> ${e.message}`;
        }
    }

    async function getLatexResponse(latexString) {
        const thinkingMessage = appendMessage('Processando LaTeX e calculando...', 'bot');
        try {
            const resp = await fetch('/calcular_latex', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ funcao: latexString })
            });
            const json = await handleApiResponse(resp, thinkingMessage);
            if (json) {
                thinkingMessage.remove();
                renderFinalResponse(json);
            }
        } catch (e) {
            if(thinkingMessage) thinkingMessage.querySelector('.bubble').innerHTML = `<strong>Erro:</strong> ${e.message}`;
        }
    }

    function renderFinalResponse(data) {
        let html = `<p>${data.tipo}</p>`;
        if (data.metodos && data.metodos.length) {
            html += '<h6>MÃ©todos Sugeridos:</h6><ul>' + data.metodos.map(m => `<li>${m}</li>`).join('') + '</ul>';
        }
        appendMessage(html, 'bot');
    }

    const observer = new MutationObserver(scrollToBottom);
    observer.observe(chatBox, { childList: true });
</script>
{% endblock %}