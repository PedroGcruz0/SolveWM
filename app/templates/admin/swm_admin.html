{% extends 'admin/base.html' %}
{% import 'admin/layout.html' as layout with context %}

{% block head_css %}
  {{ super() }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  {# === PATCH: sidebar “drawer” no mobile (SEM mudar design) === #}
  <style>
    .admin-overlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      z-index:1039;
    }

    @media (max-width: 991.98px){
      .admin-sidebar{
        position:fixed;
        top:0; left:0;
        height:100vh;
        transform: translateX(-105%);
        transition: transform .18s ease;
        z-index:1040;
      }
      html.sidebar-open .admin-sidebar{ transform: translateX(0); }
      html.sidebar-open .admin-overlay{ display:block; }
      html.sidebar-open{ overflow:hidden; }

      /* garante que o conteúdo não fique espremido */
      .admin-main{ margin-left:0 !important; width:100%; }
    }
  </style>
{% endblock %}

{# NÃO chame super() aqui -> evita a navbar padrão do Flask-Admin (e a search duplicada) #}
{% block page_body %}
<div class="admin-shell">

  {# overlay do mobile #}
  <div class="admin-overlay" id="adminOverlay"></div>

  <aside class="admin-sidebar">
    <div class="admin-brand">
      <a href="{{ url_for('site.index') }}" class="brand-link">
        <img src="{{ url_for('static', filename='img/logo.png') }}" class="brand-logo" alt="logo">
        <span class="brand-text">Solve WM</span>
      </a>

      {# botão fechar (mobile) - aparece só quando o menu está aberto #}
      <button class="btn btn-sm btn-outline-light d-lg-none" type="button" id="btnSidebarClose" aria-label="Fechar menu">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    {# mantém seu comportamento antigo: menu colapsável no mobile #}
    <div class="collapse d-lg-block" id="sidebarMenu">
      <nav class="admin-nav">

        <a class="nav-item" href="/admin">
          <i class="bi bi-speedometer2"></i><span>Painel</span>
        </a>

        <a class="nav-item" href="{{ url_for('turmas.index') }}">
          <i class="bi bi-people"></i><span>Turmas</span>
        </a>

        <a class="nav-item" href="{{ url_for('alunos.index') }}">
          <i class="bi bi-person-plus"></i><span>Alunos</span>
        </a>

        <a class="nav-item" href="/admin/usuarios">
          <i class="bi bi-person-badge"></i><span>Usuários</span>
        </a>

        <div class="nav-section">Conteúdo</div>
        <a class="nav-item" href="/admin/conteudos">
          <i class="bi bi-grid"></i><span>Conteúdos</span>
        </a>

        <a class="nav-item" href="/admin/atividades">
          <i class="bi bi-ui-checks-grid"></i><span>Atividades</span>
        </a>

        <div class="nav-section">Relatórios</div>
        <a class="nav-item" href="/admin/analise">
          <i class="bi bi-bar-chart"></i><span>Análise</span>
        </a>

      </nav>
    </div>
  </aside>

  <div class="admin-main">
    <header class="admin-topbar">
      <div class="topbar-left">

        {# === PATCH: botão ABRIR sidebar no mobile (não ocupa espaço) === #}
        <button class="btn btn-sm btn-outline-primary d-lg-none" type="button" id="btnSidebarMobile" aria-label="Abrir menu">
          <i class="bi bi-list"></i>
        </button>

        {# seu botão antigo de desktop (continua igual) #}
        <button class="btn btn-sm btn-outline-primary d-none d-lg-inline" type="button" id="btnSidebar">
          <i class="bi bi-layout-sidebar-inset"></i>
        </button>

        <span class="topbar-title">Admin</span>
      </div>

      <div class="topbar-right">
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('site.index') }}">Home</a>
        <a class="btn btn-primary btn-sm" href="{{ url_for('site.sair') }}">Sair</a>
      </div>
    </header>

    <main class="admin-content">
      {{ layout.messages() }}
      {% block body %}{% endblock %}
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // desktop: seu toggle antigo
  const btn = document.getElementById('btnSidebar');
  if (btn) {
    btn.addEventListener('click', () => {
      document.documentElement.classList.toggle('sidebar-collapsed');
    });
  }

  // mobile: abrir/fechar sidebar inteira (sem mudar design)
  (function(){
    const root = document.documentElement;
    const openBtn = document.getElementById('btnSidebarMobile');
    const closeBtn = document.getElementById('btnSidebarClose');
    const overlay = document.getElementById('adminOverlay');
    const mq = window.matchMedia("(max-width: 991.98px)");

    function openSidebar(){ root.classList.add("sidebar-open"); }
    function closeSidebar(){ root.classList.remove("sidebar-open"); }

    if (openBtn) openBtn.addEventListener("click", openSidebar);
    if (closeBtn) closeBtn.addEventListener("click", closeSidebar);
    if (overlay) overlay.addEventListener("click", closeSidebar);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && mq.matches) closeSidebar();
    });

    // se sair do mobile, garante que não fica travado com overlay
    mq.addEventListener?.("change", () => {
      if (!mq.matches) closeSidebar();
    });

    // no mobile já começa fechado
    if (mq.matches) closeSidebar();
  })();
</script>

{% endblock %}
