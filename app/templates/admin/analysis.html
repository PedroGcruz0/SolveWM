{% extends "admin/swm_admin.html" %}


{% block body %}
<div class="container-fluid mt-3">
  <h3 class="mb-3">Análise por Turma (taxa de erro por tópico)</h3>

  <form class="form-inline mb-3" method="get" action="{{ url_for('analise.index') }}">
    <label class="mr-2">Turma:</label>
    <select class="form-control mr-2" name="turma_id">
      <option value="">Todas</option>
      {% for t in turmas %}
        <option value="{{ t.id }}" {% if turma_id==t.id %}selected{% endif %}>{{ t.nome }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-primary" type="submit">Ver</button>

    <a class="btn btn-outline-primary ml-2"
       href="{{ url_for('analise.executar', turma_id=turma_id) if turma_id else url_for('analise.executar') }}">
      Rodar análise
    </a>
  </form>

{% if df_alunos is none or df_alunos.empty %}
  <div class="alert alert-warning">Sem dados ainda. O aluno precisa responder desafios antes.</div>
{% else %}
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="mb-2">Taxa de erro média por grupo</h5>
      <canvas id="chart" height="120"></canvas>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="mb-2">Distribuição por aluno</h5>
      <div style="overflow:auto;">
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              {% for c in df_alunos.columns %}
                <th>{{ c }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for _, row in df_alunos.iterrows() %}
              <tr>
                {% for c in df_alunos.columns %}
                  <td>{{ row[c] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}


{% if chart_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('chart');
  const data = {{ chart_data|tojson }};
  new Chart(ctx, { type: 'bar', data });
</script>
{% endif %}
{% endblock %}
