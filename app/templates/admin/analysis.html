{% extends 'admin/my_master.html' %}

{% block head_css %}
  {{ super() }}
  <style>
    #chart-container {
      position: relative;
      margin: auto;
      height: 60vh;
      width: 80vw;
      max-width: 900px;
    }
  </style>
{% endblock %}

{% block body %}
  <h1>
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-bar-chart-line-fill icon-header" viewBox="0 0 16 16" style="display: inline-block; margin-right: 10px; vertical-align: middle;">
        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2z"/>
    </svg>
    Dashboard de Análise de Alunos
  </h1>
  <p class="lead">
    Execute a análise para gerar ou atualizar os relatórios sobre os perfis de aprendizado.
  </p>
  
  <a href="{{ url_for('main.run_analysis_route') }}" class="btn btn-primary btn-lg mt-3 mb-4">
    Executar/Atualizar Análise
  </a>

  <hr>

  {% if analysis_df_display is not none and profiles_df_display is not none %}
    
    <h3 class="mt-4">Gráfico de Desempenho por Perfil de Aluno</h3>
    <p>O gráfico abaixo mostra a <strong>taxa de erro média (%)</strong> de cada grupo para cada estratégia. Barras mais altas indicam maior dificuldade.</p>
    <div id="chart-container" class="mb-5">
        <canvas id="kmeansChart"></canvas>
    </div>

    <h3 class="mt-4">Análise dos Perfis de Aprendizado (Grupos)</h3>
    {{ analysis_df_display.to_html(classes=['table', 'table-bordered', 'table-striped', 'table-hover'], border=0, index=False) | safe }}
    
    <h3 class="mt-4">Distribuição de Alunos por Perfil (Taxa de Erro Individual)</h3>
    {{ profiles_df_display.to_html(classes=['table', 'table-bordered', 'table-striped', 'table-hover'], index=False, border=0) | safe }}
    
    <h4 class="mt-4">Baixar Relatórios Completos</h4>
    <div class="list-group">
        <a href="{{ url_for('main.download_report', filename='analise_dos_clusters.csv') }}" class="list-group-item list-group-item-action">analise_dos_clusters.csv</a>
        <a href="{{ url_for('main.download_report', filename='resultado_clusters_usuarios.csv') }}" class="list-group-item list-group-item-action">resultado_clusters_usuarios.csv</a>
    </div>

  {% else %}
    <div class="alert alert-info mt-4">
      Nenhum relatório encontrado. Clique em "Executar/Atualizar Análise" para gerar o primeiro dashboard.
    </div>
  {% endif %}

{% endblock %}

{% block tail %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const chartData = {{ chart_data | tojson | safe }};
      if (chartData) {
        const ctx = document.getElementById('kmeansChart');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: chartData.labels,
            datasets: chartData.datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) { return value + '%' }
                },
                title: { display: true, text: 'Taxa de Erro Média (%)' }
              }
            }
          }
        });
      }
    </script>
{% endblock %}