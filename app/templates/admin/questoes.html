{% extends "admin/swm_admin.html" %}

{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h3 class="mb-0">Questões</h3>
    <div class="swm-muted">Escolha um tópico para gerenciar as questões e suas perguntas</div>
  </div>
  {% if topico_sel %}
    <a class="btn btn-outline-secondary pill" href="/admin/questoes/">
      <i class="bi bi-arrow-left"></i> Voltar aos tópicos
    </a>
  {% endif %}
</div>

{% if not topico_sel %}
  <!-- BALÕES (TÓPICOS) -->
  <div class="row g-3">
    {% for t in topicos %}
      <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
        <a href="/admin/questoes/?topico_id={{ t.id }}" class="text-decoration-none">
          <div class="swm-card h-100">
            <div class="swm-card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="swm-muted small">{{ t.disciplina.nome if t.disciplina else '' }}</div>
                  <h5 class="mb-0">{{ t.nome }}</h5>
                </div>
                <span class="badge text-bg-primary">{{ counts.get(t.id, 0) }}</span>
              </div>
              <div class="swm-muted mt-2 small">Clique para ver as questões</div>
            </div>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>

{% else %}
  <!-- LISTA DE QUESTÕES DO TÓPICO -->
  <div class="swm-card mb-3">
    <div class="swm-card-body d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <div class="swm-muted small">Tópico selecionado</div>
        <h4 class="mb-0">{{ topico_sel.nome }}</h4>
        <div class="swm-muted small">{{ topico_sel.disciplina.nome if topico_sel.disciplina else '' }}</div>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-primary pill"
           href="/admin/questao/new/?topico_id={{ topico_sel.id }}&url=/admin/questoes/?topico_id={{ topico_sel.id }}">
          <i class="bi bi-plus-circle"></i> Adicionar questão
        </a>
        <a class="btn btn-outline-primary pill" href="/admin/topico/">
          <i class="bi bi-tags"></i> Gerenciar tópicos
        </a>
      </div>
    </div>
  </div>

  {% if questoes|length == 0 %}
    <div class="alert alert-warning">Ainda não há questões neste tópico.</div>
  {% else %}
    {% for q in questoes %}
      <div class="swm-card mb-3" id="q{{ q.id }}">
        <div class="swm-card-body">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <h5 class="mb-1">{{ q.titulo }}</h5>
              <div class="swm-muted small">Criada em {{ q.criado_em.strftime("%d/%m/%Y %H:%M") if q.criado_em else "" }}</div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
              <a class="btn btn-outline-secondary btn-sm"
                 href="/admin/questao/edit/?id={{ q.id }}&url=/admin/questoes/?topico_id={{ topico_sel.id }}#q{{ q.id }}">
                Editar
              </a>

              <a class="btn btn-outline-primary btn-sm"
                 href="/admin/pergunta/new/?questao_id={{ q.id }}&url=/admin/questoes/?topico_id={{ topico_sel.id }}#q{{ q.id }}">
                <i class="bi bi-plus-circle"></i> Adicionar pergunta
              </a>
            </div>
          </div>

          <!-- Enunciado da QUESTÃO (foto | texto | latex) -->
          <div class="mt-3">
            {% if q.tipo_enunciado == "imagem" and q.enunciado_imagem %}
              <img class="swm-img-max" src="{{ url_for('static', filename='uploads/' ~ q.enunciado_imagem) }}" alt="enunciado">
            {% elif q.tipo_enunciado == "latex" and q.enunciado_latex %}
              <div class="p-3 bg-light border rounded">
                {{ q.enunciado_latex }}
              </div>
            {% elif q.enunciado_texto %}
              <div class="p-3 bg-light border rounded">
                {{ q.enunciado_texto }}
              </div>
            {% else %}
              <div class="swm-muted small">Sem enunciado definido.</div>
            {% endif %}
          </div>

          <!-- Perguntas -->
          <div class="mt-4">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <h6 class="mb-0">Perguntas</h6>
              <span class="badge text-bg-light border">{{ q.perguntas|length }}</span>
            </div>

            {% if q.perguntas|length == 0 %}
              <div class="swm-muted small">Nenhuma pergunta ainda.</div>
            {% else %}
              <div class="accordion" id="acc{{ q.id }}">
                {% for p in q.perguntas %}
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="h{{ q.id }}-{{ p.id }}">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                              data-bs-target="#c{{ q.id }}-{{ p.id }}">
                        {{ p.enunciado[:90] ~ ("…" if p.enunciado|length > 90 else "") }}
                      </button>
                    </h2>
                    <div id="c{{ q.id }}-{{ p.id }}" class="accordion-collapse collapse" data-bs-parent="#acc{{ q.id }}">
                      <div class="accordion-body">

                        <div class="d-flex justify-content-between flex-wrap gap-2 mb-2">
                          <div class="fw-semibold">Enunciado</div>
                          <a class="btn btn-outline-secondary btn-sm"
                             href="/admin/pergunta/edit/?id={{ p.id }}&url=/admin/questoes/?topico_id={{ topico_sel.id }}#q{{ q.id }}">
                            Editar pergunta
                          </a>
                        </div>
                        <div class="p-3 bg-light border rounded mb-3">{{ p.enunciado }}</div>

                        <div class="fw-semibold mb-2">Alternativas</div>
                        <div class="list-group">
                          {% for a in p.alternativas %}
                            <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                              <div class="swm-alt">
                                {{ a.texto }}
                              </div>
                              {% if a.correta %}
                                <span class="badge text-bg-success">Correta</span>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>

                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        </div>
      </div>
    {% endfor %}
  {% endif %}
{% endif %}
{% endblock %}
